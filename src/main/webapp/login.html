<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="js/jquery-3.4.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/common.css">
</head>
<body>

<div id="id01" class="modal">

    <form class="modal-content animate" onsubmit="submitForm(); return false;" method="post">
        <div class="imgcontainer">
            <img src="img_avatar2.png" alt="Avatar" class="avatar">
        </div>

        <div class="container">
            <label for="username"><b>Username</b></label>
            <input id="userName" type="text" placeholder="Enter Username" name="username" required>

            <label for="password"><b>Password</b></label>
            <input id="password" type="password" placeholder="Enter Password" name="password" required>

            <button type="submit">Login</button>
        </div>

        <div class="container" style="background-color:#f1f1f1">
            <button type="button" class="cancelbtn">Register</button>
            <span class="psw">Forgot <a href="#">password?</a></span>
        </div>
    </form>
</div>

<script>
    function submitForm() {

        var username=$("#userName").val();
        var password=$("#password").val();
        $.ajax({
            cache: true,
            type: "POST",
            url: "/authenticate",
            contentType: "application/json;charset=UTF-8",
            data:JSON.stringify({"username":username ,"password" : password}),
            dataType: "json",
            async: false,
            error: function (request) {
                console.log("Connection error: " + request.status);
            },
            success: function (data) {
                //save token
                authCallback(data);


            }
        });

    }

    function authCallback(response) {
        localStorage.setItem("token", response.token);
        $("#id01").remove();
        var $newdiv1 = $( "<div id='object1'></div>" );
        $("body").append($newdiv1);
        callHello();

    }

    function callHello() {
        $.ajax({
            cache: true,
            beforeSend: function(request) {
                request.setRequestHeader("Authorization", "Bearer " + localStorage.token);
            },
            type: "GET",
            url: "/hello",
            contentType: "application/json;charset=UTF-8",
            async: false,
            error: function(response) {
                console.log("templates.error");
            },
            complete: function(response) {
                if (response.readyState === 4 && response.status === 200) {
                    $("div#object1").text(response.responseText);
                }
            }
        });
    }

</script>

</body>
</html>